<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PQ vs TreeSet 丝滑动画 | @zhuizi1</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#0a0a1a; color:#e2e8f0; font-family:system-ui,-apple-system,sans-serif; overflow:hidden; }
    canvas { display:block; width:100%; height:100%; }
    .container { position:relative; width:100vw; height:100vh; }
    .panel {
      position:absolute; top:10px; left:10px; right:10px; max-width:380px;
      background:rgba(15,23,42,0.92); backdrop-filter:blur(12px);
      border-radius:16px; padding:16px; box-shadow:0 8px 32px rgba(0,0,0,0.4);
      z-index:10; overflow-y:auto; max-height:calc(100vh - 20px);
    }
    .title {
      text-align:center; margin-bottom:12px; font-size:20px; font-weight:bold;
      background:linear-gradient(90deg,#60a5fa,#a78bfa); -webkit-background-clip:text; color:transparent;
    }
    .btn-group { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px; }
    button {
      flex:1; min-width:100px; padding:10px 12px; background:linear-gradient(45deg,#1d4ed8,#3b82f6);
      color:white; border:none; border-radius:10px; cursor:pointer; font-weight:600;
      box-shadow:0 2px 8px rgba(0,0,0,0.3); transition:0.3s; font-size:14px;
    }
    button:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(59,130,246,0.5); }
    .stats { font-family:'Courier New',monospace; font-size:13px; line-height:1.7; color:#94a3b8; }
    .stats strong { color:#e2e8f0; }
    .footer { text-align:center; margin-top:12px; font-size:12px; color:#64748b; }
    @media (max-width: 768px) {
      .panel { left:5px; right:5px; top:5px; padding:12px; }
      .title { font-size:18px; }
      button { font-size:13px; padding:8px 10px; }
    }
  </style>
</head>
<body>
<div class="container">
  <canvas id="canvas"></canvas>
  <div class="panel">
    <div class="title">PQ vs TreeSet · 丝滑动画 | @zhuizi1</div>
    <div class="btn-group">
      <button onclick="addRandom()">插入随机数</button>
      <button onclick="pq.poll(); render()">PQ poll()</button>
      <button onclick="ts.pollFirst(); render()">TS pollFirst()</button>
      <button onclick="reset()">重置</button>
    </div>
    <div class="stats" id="stats"></div>
    <div class="footer">SG · Nov 15, 2025</div>
  </div>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let width, height;
function resize() {
  width = canvas.width = canvas.offsetWidth;
  height = canvas.height = canvas.offsetHeight;
}
resize(); window.addEventListener('resize', resize);

// 粒子系统
class Particle {
  constructor(x, y, val, color, type = 'trail') {
    this.x = x; this.y = y; this.val = val; this.color = color;
    this.vx = (Math.random()-0.5)*4; this.vy = (Math.random()-0.5)*4;
    this.life = 1; this.decay = type === 'explode' ? 0.03 : 0.02;
    this.type = type; this.scale = type === 'explode' ? 1.5 : 0.6;
  }
  update() { this.x += this.vx; this.y += this.vy; this.vy += 0.15; this.life -= this.decay; this.scale *= 0.97; }
  draw() {
    ctx.save();
    ctx.globalAlpha = this.life;
    ctx.translate(this.x, this.y);
    ctx.scale(this.scale, this.scale);
    if (this.type === 'explode') {
      ctx.shadowBlur = 25; ctx.shadowColor = this.color;
      ctx.fillStyle = this.color; ctx.font = 'bold 22px monospace';
      ctx.fillText(this.val, -12, 6);
    } else {
      ctx.fillStyle = this.color; ctx.font = '10px monospace'; ctx.fillText('·', 0, 0);
    }
    ctx.restore();
  }
}
let particles = [];

// 最小堆
class PriorityQueue {
  constructor() { this.data = []; }
  offer(x) { this.data.push(x); this.siftUp(this.data.length-1); }
  poll() {
    if (!this.data.length) return null;
    const min = this.data[0];
    this.data[0] = this.data.pop();
    this.siftDown(0);
    explode(min, width * 0.3, height / 2, '#f59e0b');
    return min;
  }
  siftUp(i) { while (i > 0) { let p = (i-1)>>1; if (this.data[p] <= this.data[i]) break; [this.data[p], this.data[i]] = [this.data[i], this.data[p]]; i = p; } }
  siftDown(i) { const n = this.data.length; while (true) { let l = 2*i+1, r = 2*i+2, s = i; if (l < n && this.data[l] < this.data[s]) s = l; if (r < n && this.data[r] < this.data[s]) s = r; if (s === i) break; [this.data[i], this.data[s]] = [this.data[s], this.data[i]]; i = s; } }
  peek() { return this.data[0]; }
  size() { return this.data.length; }
}

// 红黑树（简化版，支持删除）
class TreeSet {
  constructor() { this.root = null; this.size = 0; }
  add(x) { if (this.contains(x)) return; this.root = this.insert(this.root, x); this.size++; }
  insert(node, x) {
    if (!node) return {val: x, left: null, right: null, color: 'red', scale: 0, opacity: 0};
    if (x < node.val) node.left = this.insert(node.left, x);
    else if (x > node.val) node.right = this.insert(node.right, x);
    return node;
  }
  pollFirst() {
    if (!this.root) return null;
    const min = this.findMin(this.root);
    this.root = this.delete(this.root, min);
    this.size--;
    explode(min, width * 0.7, height / 2, '#ef4444');
    return min;
  }
  findMin(node) { return node.left ? this.findMin(node.left) : node.val; }
  delete(node, x) {
    if (!node) return null;
    if (x < node.val) node.left = this.delete(node.left, x);
    else if (x > node.val) node.right = this.delete(node.right, x);
    else {
      if (!node.left) return node.right;
      if (!node.right) return node.left;
      const min = this.findMin(node.right);
      node.val = min;
      node.right = this.delete(node.right, min);
    }
    return node;
  }
  contains(x) { return this._contains(this.root, x); }
  _contains(node, x) { if (!node) return false; if (x === node.val) return true; return x < node.val ? this._contains(node.left, x) : this._contains(node.right, x); }
}

const pq = new PriorityQueue();
const ts = new TreeSet();

// 爆炸粒子
function explode(val, x, y, color) {
  for (let i = 0; i < 12; i++) {
    const angle = i * Math.PI * 2 / 12;
    const p = new Particle(x, y, val, color, 'explode');
    p.vx = Math.cos(angle) * 7; p.vy = Math.sin(angle) * 7;
    particles.push(p);
  }
}

function addRandom() {
  const val = Math.floor(Math.random() * 100);
  const startX = width / 2;
  const startY = 80;
  for (let i = 0; i < 15; i++) {
    setTimeout(() => particles.push(new Particle(startX + (Math.random()-0.5)*80, startY + i*12, '', '#60a5fa')), i * 35);
  }
  setTimeout(() => { pq.offer(val); ts.add(val); render(); }, 500);
}

function reset() {
  pq.data = []; ts.root = null; ts.size = 0; particles = []; render();
}

// 背景星空
let stars = Array.from({length: 80}, () => ({
  x: Math.random()*width, y: Math.random()*height, size: Math.random()*1.5, speed: Math.random()*0.4+0.1
}));

let time = 0;
function render() {
  time += 0.016;
  ctx.fillStyle = '#0a0a1a'; ctx.fillRect(0,0,width,height);

  // 星空
  stars.forEach(s => {
    s.x -= s.speed;
    if (s.x < 0) s.x = width;
    ctx.fillStyle = `rgba(255,255,255,${s.size/2})`;
    ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI*2); ctx.fill();
  });

  // 粒子
  particles = particles.filter(p => p.life > 0);
  particles.forEach(p => { p.update(); p.draw(); });

  drawPQ();
  drawTreeSet();
  updateStats();
  requestAnimationFrame(render);
}

function drawPQ() {
  const scale = Math.min(width, height) / 800;
  const centerX = width * 0.3;
  const centerY = height / 2;
  const baseR = 100 * scale;
  pq.data.forEach((val, i) => {
    const angle = (i / Math.max(pq.data.length, 1)) * Math.PI * 2;
    const r = baseR + (i % 4) * 40 * scale;
    const x = centerX + Math.cos(angle + time*0.4) * r;
    const y = centerY + Math.sin(angle + time*0.4) * r;

    ctx.shadowBlur = i === 0 ? 35 * (0.5 + 0.5*Math.sin(time*5)) : 12;
    ctx.shadowColor = i === 0 ? '#f59e0b' : '#3b82f6';
    ctx.fillStyle = i === 0 ? '#f59e0b' : '#3b82f6';
    ctx.beginPath(); ctx.arc(x, y, 22 * scale, 0, Math.PI*2); ctx.fill();
    ctx.shadowBlur = 0;
    ctx.fillStyle = 'white'; ctx.font = `bold ${16*scale}px monospace`; ctx.textAlign = 'center';
    ctx.fillText(val, x, y + 6*scale);
  });
  ctx.fillStyle = '#e2e8f0'; ctx.font = `bold ${20*scale}px system-ui`; ctx.textAlign = 'center';
  ctx.fillText('PriorityQueue (最小堆)', centerX, centerY - 180*scale);
}

function drawNode(node, x, y, offset, depth = 0, scale = 1) {
  if (!node) return;
  if (!node.scale) node.scale = 0; if (!node.opacity) node.opacity = 0;
  node.scale = Math.min(node.scale + 0.12, 1);
  node.opacity = Math.min(node.opacity + 0.18, 1);

  ctx.save();
  ctx.globalAlpha = node.opacity;
  ctx.translate(x, y);
  ctx.rotate(Math.sin(time + depth) * 0.06);
  ctx.scale(node.scale * scale, node.scale * scale);

  ctx.shadowBlur = 22; ctx.shadowColor = '#ef4444';
  ctx.fillStyle = '#ef4444';
  ctx.beginPath(); ctx.arc(0, 0, 24 * scale, 0, Math.PI*2); ctx.fill();
  ctx.shadowBlur = 0;
  ctx.fillStyle = 'white'; ctx.font = `bold ${16*scale}px monospace`; ctx.textAlign = 'center';
  ctx.fillText(node.val, 0, 6*scale);
  ctx.restore();

  const childOffset = offset * 0.6;
  if (node.left) {
    ctx.strokeStyle = '#64748b'; ctx.lineWidth = 2 * scale;
    ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x - childOffset, y + 90*scale); ctx.stroke();
    drawNode(node.left, x - childOffset, y + 90*scale, childOffset, depth + 1, scale);
  }
  if (node.right) {
    ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x + childOffset, y + 90*scale); ctx.stroke();
    drawNode(node.right, x + childOffset, y + 90*scale, childOffset, depth + 1, scale);
  }
}

function drawTreeSet() {
  const scale = Math.min(width, height) / 800;
  const centerX = width * 0.7;
  const centerY = height / 2;
  const baseOffset = 180 * scale;
  drawNode(ts.root, centerX, centerY - 100*scale, baseOffset, 0, scale);
  ctx.fillStyle = '#e2e8f0'; ctx.font = `bold ${20*scale}px system-ui`; ctx.textAlign = 'center';
  ctx.fillText('TreeSet (红黑树)', centerX, centerY - 180*scale);
}

function updateStats() {
  document.getElementById('stats').innerHTML = `
    <strong>PQ:</strong> ${pq.size()} 个，最小=<span style="color:#f59e0b">${pq.peek()||'-'}</span><br>
    <strong>TS:</strong> ${ts.size} 个，最小=<span style="color:#ef4444">${ts.findMin(ts.root)||'-'}</span><br>
    <strong>内存:</strong> PQ ~${(pq.size()*4/1024).toFixed(1)}KB | TS ~${(ts.size*32/1024).toFixed(1)}KB
  `;
}

render();
</script>
</body>
</html>
